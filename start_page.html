<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Start Page</title>
<style>
  :root{
    --bg:#0f1115;--panel:#141821;--panel-2:#0f131a;--text:#e6e9ef;--muted:#94a3b8;--accent:#22d3ee;--accent-2:#60a5fa;--tile:#1b2230;--tile-hover:#232c3f;--danger:#ef4444;--ok:#10b981;
    --radius:18px;--gap:14px;--shadow:0 10px 30px rgba(0,0,0,.4);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--panel-2));color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
  .brand{font-weight:700;font-size:20px;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{background:var(--panel);padding:8px 12px;border-radius:999px;color:var(--muted);cursor:pointer;border:1px solid transparent;display:inline-flex;align-items:center;gap:8px}
  .tab.active{color:var(--text);background:linear-gradient(180deg,var(--panel),var(--tile));border-color:#1f2937}
  .badge{font-size:12px;padding:2px 6px;border-radius:999px;background:#0e1523;border:1px solid #233046;color:#cbd5e1}
  .grow{flex:1}
  .search{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid #1f2937;padding:8px 10px;border-radius:999px;min-width:220px}
  .search input{background:transparent;border:none;outline:none;color:var(--text);width:180px}
  .controls{display:flex;gap:8px;margin-left:auto}
  .btn{background:var(--panel);border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
  .btn:hover{background:var(--tile-hover)}
  .btn.ok{border-color:#0f5132;background:#0b3b2a}
  .btn.warn{border-color:#3f2020;background:#281515}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--gap)}
  .tile{background:var(--tile);border:1px solid #243044;border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:10px;position:relative;user-select:none}
  .tile:hover{background:var(--tile-hover)}
  .tile:focus{outline:2px solid var(--accent);outline-offset:2px}
  .ico{width:48px;height:48px;border-radius:12px;background:#0b1220;display:grid;place-items:center;overflow:hidden}
  .ico img{width:100%;height:100%;object-fit:cover}
  .lbl{font-weight:600;text-align:center}
  .host{font-size:12px;color:var(--muted)}
  .kebab{position:absolute;top:8px;right:8px;background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px;margin:16px 0}
  details>summary{cursor:pointer;color:var(--muted)}
  dialog{border:none;border-radius:18px;background:var(--panel);color:var(--text);box-shadow:var(--shadow);max-width:560px;width:min(560px,92%)}
  form{display:grid;gap:10px;padding:16px}
  input[type=text],input[type=url]{width:100%;padding:10px;border-radius:10px;border:1px solid #223048;background:#0e1523;color:var(--text)}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;margin:2px;color:#cbd5e1}
  footer{opacity:.6;text-align:center;margin:24px 0}
  .drop-hint{outline:2px dashed #334155;outline-offset:4px}
  .empty{border:1px dashed #2a384f;border-radius:var(--radius);padding:24px;text-align:center;color:var(--muted)}
  /* tiny context actions for tabs */
  .tab-actions{display:none;position:absolute;background:var(--panel);border:1px solid #1f2937;border-radius:10px;box-shadow:var(--shadow);padding:6px;z-index:50}
  .tab-actions button{display:block;width:100%;text-align:left;border:0;background:transparent;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  .tab-actions button:hover{background:var(--tile-hover)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Start Page</div>
      <div class="tabs" id="tabs" role="tablist" aria-label="Categories"></div>
      <div class="grow"></div>
      <label class="search" title="Filter links">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="q" placeholder="Search" aria-label="Search links" />
      </label>
      <div class="controls">
        <button class="btn" id="addLinkBtn">+ Link</button>
        <button class="btn" id="addCatBtn">+ Tab</button>
        <button class="btn" id="manageCatBtn">Manage Tabs</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <input id="fileInput" type="file" accept="application/json" hidden>
      </div>
    </header>

    <section class="grid" id="grid" aria-live="polite"></section>
    <div id="emptyState" class="empty" hidden>No links in this tab. Add one with <strong>+ Link</strong>.</div>

    <details class="panel">
      <summary>Tips</summary>
      <div class="muted" style="margin-top:8px">
        <div class="pill">Click tile = open</div>
        <div class="pill">Ctrl/⌘+Click = new tab</div>
        <div class="pill">Enter = open • Ctrl/⌘+Enter = new tab</div>
        <div class="pill">Right-click tile/tab = edit</div>
        <div class="pill">Drag tile to reorder</div>
        <div class="pill">Export to back up</div>
        <p>Data is stored in <strong>localStorage</strong>. You can also preload with <code>?data=</code> containing base64 of an exported JSON.</p>
      </div>
    </details>

    <footer>Local, offline, single file. No libraries.</footer>
  </div>

  <dialog id="linkDialog">
    <form id="linkForm">
      <h3 id="dlgTitle">Add link</h3>
      <div class="row">
        <div>
          <label for="f_name">Name</label>
          <input id="f_name" type="text" required>
        </div>
        <div>
          <label for="f_url">URL</label>
          <input id="f_url" type="url" placeholder="https://example.com" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="f_cat">Category</label>
          <input id="f_cat" type="text" list="catlist" required>
          <datalist id="catlist"></datalist>
        </div>
        <div>
          <label for="f_icon">Icon (optional)</label>
          <input id="f_icon" type="url" placeholder="https://site/icon.png">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="f_note">Note (optional)</label>
          <input id="f_note" type="text" placeholder="e.g. work, shopping">
        </div>
        <div>
          <label for="f_color">Color (optional)</label>
          <input id="f_color" type="text" placeholder="#334155 or 'auto'">
        </div>
      </div>
      <div class="row">
        <button type="submit" class="btn ok">Save</button>
        <button type="button" class="btn" id="cancelDlg">Cancel</button>
        <button type="button" class="btn warn" id="deleteBtn" style="margin-left:auto;display:none">Delete</button>
      </div>
    </form>
  </dialog>

  <dialog id="manageDialog">
    <form id="manageForm">
      <h3>Manage tabs</h3>
      <div id="catListUI" style="display:grid;gap:8px;padding:0 4px 8px"></div>
      <div class="row">
        <button type="button" class="btn" id="closeManage">Close</button>
      </div>
    </form>
  </dialog>

<script>
/* ================= Core ================= */
const STORAGE_KEY = 'startPage.v2';
let DB = loadFromStorage();
let currentCat = loadCurrentCat();

/* URL preload: ?data=base64(json) */
try{
  const u = new URL(location.href);
  const b64 = u.searchParams.get('data');
  if(b64){ DB = JSON.parse(atob(b64)); saveToStorage(); }
}catch{}

/* Elements */
const tabsEl  = document.getElementById('tabs');
const gridEl  = document.getElementById('grid');
const qEl     = document.getElementById('q');
const linkDlg = document.getElementById('linkDialog');
const linkForm= document.getElementById('linkForm');
const deleteBtn=document.getElementById('deleteBtn');
const catList = document.getElementById('catlist');
const emptyEl = document.getElementById('emptyState');
const manageDlg = document.getElementById('manageDialog');
const catListUI = document.getElementById('catListUI');

/* ================= Render ================= */
function renderTabs(){
  tabsEl.innerHTML = '';
  DB.categories.forEach(cat=>{
    const count = DB.links.filter(l=>l.cat===cat).length;
    const b = document.createElement('button');
    b.className = 'tab'+(cat===currentCat?' active':'');
    b.setAttribute('role','tab');
    b.setAttribute('aria-selected', String(cat===currentCat));
    b.textContent = cat;
    const badge = document.createElement('span'); badge.className='badge'; badge.textContent = count;
    b.appendChild(badge);
    b.onclick = ()=>{ currentCat = cat; saveCurrentCat(); render(); };
    b.oncontextmenu = (e)=>{ e.preventDefault(); editCategoryPrompt(cat); };
    tabsEl.appendChild(b);
  });
}
function renderCatOptions(){
  catList.innerHTML = '';
  DB.categories.forEach(c=>{
    const o=document.createElement('option');o.value=c;catList.appendChild(o);
  });
}
function hostFrom(url){
  try{return new URL(url).hostname.replace(/^www\./,'');}catch{return '';}
}
function iconFor(url, fallback){
  try{
    const u = new URL(url);
    return `${u.origin}/favicon.ico`;
  }catch{ return fallback||''; }
}
function tileHTML(link){
  const iconUrl = link.icon || iconFor(link.url,'');
  const color = link.color && link.color.toLowerCase()!=='auto' ? link.color : '';
  return `
  <article class="tile" data-id="${link.id}" draggable="true" tabindex="0" ${(color?`style="border-color:${escapeAttr(color)}"`: '')} aria-label="${escapeAttr(link.name)}">
    <button class="kebab" title="Edit" aria-label="Edit link">⋮</button>
    <div class="ico">${iconUrl?`<img src="${escapeAttr(iconUrl)}" alt="">`:`<span aria-hidden="true">🌐</span>`}</div>
    <div class="lbl">${escapeHTML(link.name)}</div>
    <div class="host">${escapeHTML(hostFrom(link.url))}</div>
  </article>`;
}
function render(){
  ensureCurrentCatExists();
  renderTabs();
  renderCatOptions();
  const q = qEl.value.trim().toLowerCase();
  let items = DB.links.filter(l=>l.cat===currentCat);
  if(q){ items = items.filter(l=> `${l.name} ${l.url} ${l.note||''}`.toLowerCase().includes(q)); }
  items.sort((a,b)=>(a.order??0)-(b.order??0));
  gridEl.innerHTML = items.map(tileHTML).join('');
  emptyEl.hidden = items.length>0;

  gridEl.querySelectorAll('.tile').forEach(t=>{
    const id = t.dataset.id;
    const link = DB.links.find(x=>x.id===id);
    // pointer opens
    t.addEventListener('click', e=>{
      if(e.target.classList.contains('kebab')) return;
      window.open(link.url, e.ctrlKey||e.metaKey ? '_blank':'_self');
    });
    // keyboard
    t.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        window.open(link.url, e.ctrlKey||e.metaKey ? '_blank':'_self');
      }
    });
    // edit
    t.querySelector('.kebab').onclick = (e)=>{ e.stopPropagation(); openEdit(link); };
    t.oncontextmenu = (e)=>{ e.preventDefault(); openEdit(link); };
    // drag n drop
    t.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', id); t.classList.add('drop-hint'); });
    t.addEventListener('dragend', ()=> t.classList.remove('drop-hint'));
    t.addEventListener('dragover', e=> e.preventDefault());
    t.addEventListener('drop', e=>{
      e.preventDefault();
      const fromId = e.dataTransfer.getData('text/plain');
      reorderWithinCategory(fromId,id);
    });
  });
}

/* ================= Reorder ================= */
function reorderWithinCategory(fromId,toId){
  const arr = DB.links.filter(l=>l.cat===currentCat);
  const from = arr.findIndex(l=>l.id===fromId); const to = arr.findIndex(l=>l.id===toId);
  if(from<0||to<0) return;
  const ids = arr.map(l=>l.id);
  ids.splice(to,0,ids.splice(from,1)[0]);
  ids.forEach((id,i)=>{ const ln = DB.links.find(l=>l.id===id); if(ln) ln.order = i; });
  saveToStorage(); render();
}

/* ================= CRUD Links ================= */
function uid(){ return Math.random().toString(36).slice(2,9); }
function openAdd(){
  linkForm.reset();
  document.getElementById('dlgTitle').textContent = 'Add link';
  document.getElementById('f_cat').value = currentCat;
  linkForm.dataset.editId = '';
  deleteBtn.style.display='none';
  linkDlg.showModal();
  document.getElementById('f_name').focus();
}
function openEdit(link){
  document.getElementById('dlgTitle').textContent = 'Edit link';
  document.getElementById('f_name').value = link.name;
  document.getElementById('f_url').value = link.url;
  document.getElementById('f_cat').value = link.cat;
  document.getElementById('f_icon').value = link.icon||'';
  document.getElementById('f_note').value = link.note||'';
  document.getElementById('f_color').value = link.color||'';
  linkForm.dataset.editId = link.id;
  deleteBtn.style.display='inline-block';
  linkDlg.showModal();
  document.getElementById('f_name').focus();
}

linkForm.onsubmit = (e)=>{
  e.preventDefault();
  const data = {
    name: val('f_name'), url: normalizeUrl(val('f_url')), cat: val('f_cat'), icon: val('f_icon'), note: val('f_note'), color: val('f_color')
  };
  if(!validUrl(data.url)){ alert('Invalid URL'); return; }
  if(!data.cat){ alert('Category required'); return; }
  if(!DB.categories.includes(data.cat)) DB.categories.push(data.cat);

  const editId = linkForm.dataset.editId;
  if(editId){
    const i = DB.links.findIndex(l=>l.id===editId);
    if(i>-1){ DB.links[i] = { ...DB.links[i], ...data } }
  }else{
    const order = nextOrderFor(data.cat);
    DB.links.push({ id: uid(), order, ...data });
  }
  saveToStorage(); linkDlg.close(); render();
};

function nextOrderFor(cat){
  const orders = DB.links.filter(l=>l.cat===cat).map(l=>l.order||0);
  return orders.length? Math.max(...orders)+1 : 0;
}
function val(id){ return document.getElementById(id).value.trim(); }

/* Delete link */
deleteBtn.onclick = ()=>{
  const id = linkForm.dataset.editId;
  if(id){
    DB.links = DB.links.filter(l=>l.id!==id);
    saveToStorage(); linkDlg.close(); render();
  }
};

/* ================= Categories ================= */
function ensureCurrentCatExists(){
  if(!DB.categories.includes(currentCat)){
    currentCat = DB.categories[0] || 'Home';
  }
}

function addCategory(name){
  name = (name||'').trim();
  if(!name) return;
  if(DB.categories.includes(name)){ currentCat = name; saveCurrentCat(); return render(); }
  DB.categories.push(name);
  currentCat = name;
  saveToStorage(); saveCurrentCat(); render();
}

function renameCategory(oldName, newName){
  newName = (newName||'').trim();
  if(!newName || newName===oldName) return;
  if(DB.categories.includes(newName)){ alert('A tab with that name already exists.'); return; }
  DB.categories = DB.categories.map(c=>c===oldName?newName:c);
  DB.links.forEach(l=>{ if(l.cat===oldName) l.cat=newName; });
  if(currentCat===oldName) currentCat=newName;
  saveToStorage(); saveCurrentCat(); render();
}

function deleteCategory(name){
  if(DB.categories.length<=1){ alert('At least one tab is required.'); return; }
  const linked = DB.links.filter(l=>l.cat===name).length;
  let moveTo = DB.categories.find(c=>c!==name) || 'Home';
  if(linked){
    const choice = prompt(`Move ${linked} link(s) to which tab?`, moveTo);
    if(!choice){ return; }
    if(!DB.categories.includes(choice)){ DB.categories.push(choice); }
    DB.links.forEach(l=>{ if(l.cat===name) l.cat=choice; });
  }
  DB.categories = DB.categories.filter(c=>c!==name);
  if(currentCat===name) currentCat = DB.categories[0];
  saveToStorage(); saveCurrentCat(); render();
}

function editCategoryPrompt(cat){
  const action = prompt(`Tab: "${cat}"\nType: rename  or  delete\nOr enter new name to rename.`, 'rename');
  if(!action) return;
  if(action.toLowerCase()==='delete'){ deleteCategory(cat); }
  else if(action.toLowerCase()==='rename' || action.trim()!=='' ){ 
    const newName = action.toLowerCase()==='rename' ? prompt('New tab name:', cat) : action;
    if(newName!=null) renameCategory(cat,newName);
  }
}

/* Manage dialog list */
function openManage(){
  catListUI.innerHTML = '';
  DB.categories.forEach(c=>{
    const row = document.createElement('div');
    row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='8px';
    const inp = document.createElement('input'); inp.type='text'; inp.value=c; inp.style.background='#0e1523'; inp.style.border='1px solid #223048'; inp.style.color='var(--text)'; inp.style.borderRadius='8px'; inp.ariaLabel='Category name';
    const btnRename = document.createElement('button'); btnRename.className='btn'; btnRename.textContent='Rename';
    const btnDel = document.createElement('button'); btnDel.className='btn warn'; btnDel.textContent='Delete';
    btnRename.onclick=()=> renameCategory(c, inp.value);
    btnDel.onclick=()=> deleteCategory(c);
    row.appendChild(inp); row.appendChild(btnRename); row.appendChild(btnDel);
    catListUI.appendChild(row);
  });
  manageDlg.showModal();
}

/* ================= Storage ================= */
function loadFromStorage(){
  const blank = {
    categories:["Home","Shopping","Travel"],
    links:[
      {id:uid(),name:'Amazon',url:'https://amazon.com',cat:'Shopping',order:0},
      {id:uid(),name:'Github',url:'https://github.com',cat:'Home',order:0},
      {id:uid(),name:'Gmail',url:'https://mail.google.com',cat:'Home',order:1},
      {id:uid(),name:'Discord',url:'https://discord.com/app',cat:'Home',order:2},
      {id:uid(),name:'YouTube',url:'https://youtube.com',cat:'Home',order:3},
      {id:uid(),name:'Maps',url:'https://maps.google.com',cat:'Travel',order:0}
    ]
  };
  try{
    const rawV2 = localStorage.getItem(STORAGE_KEY);
    if(rawV2) return JSON.parse(rawV2);

    // migrate v1 if present
    const rawV1 = localStorage.getItem('startPage.v1');
    if(rawV1){
      const v1 = JSON.parse(rawV1);
      // v1 schema is compatible; just save as v2
      localStorage.setItem(STORAGE_KEY, JSON.stringify(v1));
      return v1;
    }
    return blank;
  }catch(e){ console.warn('storage error',e); return blank; }
}
function saveToStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
}
function loadCurrentCat(){
  try{ return localStorage.getItem(STORAGE_KEY+'.currentCat') || (DB.categories[0]||'Home'); }catch{ return DB.categories[0]||'Home'; }
}
function saveCurrentCat(){
  try{ localStorage.setItem(STORAGE_KEY+'.currentCat', currentCat); }catch{}
}

/* ================= Utilities ================= */
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
function normalizeUrl(u){
  if(!u) return u;
  if(/^https?:\/\//i.test(u)) return u;
  return 'https://' + u;
}
function validUrl(u){
  try{ new URL(u); return true; }catch{ return false; }
}

/* ================= Buttons & handlers ================= */
qEl.addEventListener('input', render);

document.getElementById('addLinkBtn').onclick = openAdd;

document.getElementById('addCatBtn').onclick = ()=>{
  const name = prompt('New tab name');
  if(!name) return;
  addCategory(name);
};

document.getElementById('manageCatBtn').onclick = openManage;
document.getElementById('closeManage').onclick = ()=> manageDlg.close();

document.getElementById('exportBtn').onclick = ()=>{
  const ts = new Date().toISOString().slice(0,10);
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `start-page-${ts}.json`;
  a.click();
};

document.getElementById('importBtn').onclick = ()=> document.getElementById('fileInput').click();

document.getElementById('fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); 
    const obj = JSON.parse(txt); 
    if(obj.categories && obj.links){ 
      if(confirm('Merge with existing data? Press OK to merge, Cancel to replace.')){
        // merge categories
        obj.categories.forEach(c=>{ if(!DB.categories.includes(c)) DB.categories.push(c); });
        // merge links by url+name uniqueness
        const key = l=> `${l.name}|${l.url}`.toLowerCase();
        const existing = new Set(DB.links.map(key));
        obj.links.forEach(l=>{
          if(!DB.categories.includes(l.cat)) DB.categories.push(l.cat);
          if(!existing.has(key(l))) DB.links.push({...l, id: uid(), order: nextOrderFor(l.cat)});
        });
      }else{
        DB=obj;
      }
      saveToStorage(); render();
    } else { alert('Invalid file'); }
  }catch(err){ alert('Import failed: '+err.message); }
});

/* Dialog close */
document.getElementById('cancelDlg').onclick = ()=> linkDlg.close();
linkDlg.addEventListener('click', (e)=>{ if(e.target===linkDlg) linkDlg.close(); });
manageDlg.addEventListener('click', (e)=>{ if(e.target===manageDlg) manageDlg.close(); });

/* Keyboard: quick add and nav */
window.addEventListener('keydown', (e)=>{
  if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); openAdd(); }
  if(e.key==='f' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); qEl.focus(); qEl.select(); }
});

/* Initial paint */
render();
</script>
</body>
</html>

